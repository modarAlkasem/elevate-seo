name: CI - Backend Tests

on:
    push:
        branches:
            - feature/**
            - bugfix/**

        paths:
            - "backend/apps/**"
            - "backend/config/**"
            - "backend/tests/**"
            - "backend/requirements/txt"
            - backend/Dockerfile*"
            - ".github/workflows/ci-backend.yml"

    pull_request:
        branches:
            - main
        paths:
            - "backend/apps/**"
            - "backend/config/**"
            - "backend/tests/**"
            - "backend/requirements.txt"

env:
    PYTHON_VERSION: "3.14"

jobs:
    backend-tests:
        name: Django tests
        runs-on: ubuntu-latest
        env:
            SECRET_KEY: ${{secrets.SECRET_KEY}}
            DEBUG: ${{vars.DEBUG}}
            ENV: ${{vars.ENV}}
            RELEASE_VERSION: ${{vars.RELEASE_VERSION}}
            DB_ENGINE: ${{vars.DB_ENGINE}}
            DB_HOST: ${{vars.DB_HOST}}
            DB_PORT: ${{vars.DB_PORT}}
            DB_USER: ${{secrets.DB_USER}}
            DB_PASSWORD: ${{secrets.DB_PASSWORD}}
            DB_NAME: ${{vars.DB_NAME}}
            RABBITMQ_DEFAULT_USER: ${{secrets.RABBITMQ_DEFAULT_USER}}
            RABBITMQ_DEFAULT_PASS: ${{secrets.RABBITMQ_DEFAULT_PASS}}
            REDIS_HOST: ${{vars.REDIS_HOST}}
            REDIS_PORT: ${{vars.REDIS_PORT}}

        services:
            db:
                image: postgres:18.0-alpine
                env:
                    POSTGRES_USER: ${{secrets.DB_USER}}
                    POSTGRES_PASSWORD: ${{secrets.DB_PASSWORD}}
                    POSTGRES_DB: ${{vars.DB_NAME}}

                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

                ports:
                    - 5432:5432

            redis:
                image: redis:8.2.3
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

                ports:
                    - 6379:6379

            rabbitmq:
                image: rabbitmq:4.2.0-management-alpine
                env:
                    RABBITMQ_DEFAULT_USER: ${{secrets.RABBITMQ_DEFAULT_USER}}
                    RABBITMQ_DEFAULT_PASS: ${{secrets.RABBITMQ_DEFAULT_PASS}}

                options: >-
                    --health-cmd "rabbitmq-diagnostics -q ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

                ports:
                    - 5672:5672

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{env.PYTHON_VERSION}}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r backend/requirements.txt

            - name: Run linting
              run: |
                  pip install flake8 black isort
                  flake8 backend/apps/ backend/config/ --max-line-height=100 --exclude=migrations
                  black --check backend/apps/ backend/config/
                  isort --check backend/apps/ backend/config/

            - name: Run Django system checks

              run: |
                  cd backend && python manage.py check --deploy

            - name: Run migrations check
              run: |
                  cd backend && python  manage.py makemigrations --check --dry-run --no-input

            - name: Run Django tests
              env:
                  CELERY_BROKER_URL: ${{vars.CELERY_BROKER_URL}}
                  CELERY_RESULT_BACKEND: ${{vars.CELERY_RESULT_BACKEND}}
                  GOOGLE_CLIENT_ID: ${{secrets.GOOGLE_CLIENT_ID}}
                  GOOGLE_CLIENT_SECRET: ${{secrets.GOOGLE_CLIENT_SECRET}}
                  SENTRY_DSN: ${{secrets.SENTRY_DSN}}
                  BRIGHTDATA_API_KEY: ${{secrets.BRIGHTDATA_API_KEY}}
                  BRIGHTDATA_WEBHOOK_SECRET: ${{secrets.  BRIGHTDATA_WEBHOOK_SECRET}}
                  BRIGHTDATA_DATASET_ID: ${{secrets.  BRIGHTDATA_DATASET_ID}}
                  GOOGLE_API_KEY: ${{secrets.GOOGLE_API_KEY}}
                  GOOGLE_GEMINI_MODEL_IDENTIFIER: ${{vars.  GOOGLE_GEMINI_MODEL_IDENTIFIER}}

              run: |
                  cd backend && pytest tests/ \
                  --cov=apps \
                  --cov-report=xml \
                  --cov-report=term-missing \
                  --cov-report=html \
                  --verbose \
                  --tb=short

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              if: always()
              with:
                  file: ./backend/coverage.xml
                  flags: backend
                  name: backend-coverage
                  fail_ci_if_error: false

            - name: Archive coverage report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: backend-coverage-report
                  path: backend/htmlcov/

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  severity: "CRITICAL,HIGH"
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy results to GitHub Security
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

            - name: Run Bandit security linter
              run: |
                  pip install bandit
                  bandit -r backend/apps/ -f json -o bandit-report.json || true

            - name: Upload Bundit report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: bandit-security-report
                  path: ./bandit-report.json
